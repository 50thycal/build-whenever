<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Meditate</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
:root {
  --bg: #0b0b0b;
  --fg: #e7e7e7;
  --muted: #a0a0a0;
  --accent: #9bd0ff;
  --ring: conic-gradient(var(--accent) var(--deg, 0deg), #222 0deg);
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
  background: var(--bg);
  color: var(--fg);
  -webkit-font-smoothing: antialiased;
}

.appbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
}
.appbar h1 { margin: 0; font-size: 18px; font-weight: 600; }
.ghost {
  background: transparent;
  color: var(--fg);
  border: 1px solid #2a2a2a;
  padding: 8px 12px;
  border-radius: 10px;
}
.primary {
  background: var(--fg);
  color: #111;
  border: none;
  padding: 10px 14px;
  border-radius: 12px;
  font-weight: 600;
}
.link {
  background: transparent;
  border: none;
  color: var(--accent);
  padding: 6px 8px;
  text-decoration: underline;
}
.hint { color: var(--muted); font-size: 12px; margin-left: 8px; }

.container {
  padding: 8px 16px 32px;
  max-width: 560px;
  margin: 0 auto;
}

.chip-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}
.chip {
  background: #141414;
  color: var(--fg);
  border: 1px solid #262626;
  padding: 10px 14px;
  border-radius: 1000px;
}
.chip.active { border-color: var(--accent); color: var(--accent); }

.timer-card {
  display: grid;
  place-items: center;
  gap: 18px;
  background: #0f0f0f;
  border: 1px solid #1d1d1d;
  border-radius: 16px;
  padding: 28px 18px 22px;
}

.ring {
  width: 220px;
  height: 220px;
  border-radius: 50%;
  background: var(--ring);
  position: relative;
}
.ring::after {
  content: "";
  position: absolute;
  inset: 10px;
  border-radius: 50%;
  background: #0f0f0f;
  border: 1px solid #1d1d1d;
}

.time {
  position: absolute;
  font-variant-numeric: tabular-nums;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size: 40px;
  letter-spacing: 1px;
  transform: translateY(-8px);
}

.controls {
  display: flex;
  gap: 10px;
}
.status { margin-top: -8px; }

.sheet[open], dialog[open] { display: block; }
.sheet:not([hidden]) {
  position: fixed;
  inset: 0;
  display: grid;
  place-items: end center;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(2px);
}
.sheet-body {
  width: 100%;
  max-width: 560px;
  background: #101010;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  border: 1px solid #1d1d1d;
  padding: 20px;
}
.sheet-body h2 { margin-top: 6px; }

.sheet-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

dialog {
  border: 1px solid #1f1f1f;
  border-radius: 12px;
  background: #101010;
  color: var(--fg);
  padding: 14px 16px 16px;
  max-width: 92vw;
}
dialog::backdrop { background: rgba(0,0,0,.4); }

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-block: 8px 14px;
}
label { font-size: 13px; color: var(--muted); display: grid; gap: 6px; }
input[type="number"] {
  width: 100%;
  border-radius: 10px;
  border: 1px solid #2a2a2a;
  background: #0f0f0f;
  color: var(--fg);
  padding: 10px 12px;
  font-size: 16px;
}

.a2h:not([hidden]) {
  position: fixed;
  left: 12px;
  right: 12px;
  bottom: 12px;
  background: #141414;
  border: 1px solid #222;
  border-radius: 12px;
  padding: 10px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* --- Visual overlays: flash + dim --- */

#flashOverlay,
#dimOverlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 999; /* above app UI */
}

/* Flash: bright white, used briefly at session end */
#flashOverlay {
  background: #ffffff;
  opacity: 0;
}

.flash-on {
  animation: flashScreen 1.2s ease-out 1;
}

@keyframes flashScreen {
  0% { opacity: 0; }
  15% { opacity: 1; }      /* full flash */
  40% { opacity: 0.1; }    /* fade back down */
  65% { opacity: 1; }      /* second flash */
  100% { opacity: 0; }     /* back to dark */
}

/* Dim overlay: dark veil over the whole app while running */
#dimOverlay {
  background: rgba(0, 0, 0, 0);
  transition: background 0.4s ease-out;
}

/* When dimmed, make the app *almost* completely dark */
body.dimmed #dimOverlay {
  background: rgba(0, 0, 0, 0.9);
}
  </style>
</head>
<body>
  <header class="appbar">
    <h1>Meditate</h1>
    <button id="infoBtn" aria-label="Open help" class="ghost">ⓘ</button>
  </header>

  <main class="container">
    <section class="chip-row" role="group" aria-label="Session durations">
      <button class="chip" data-min="3">3m</button>
      <button class="chip" data-min="5">5m</button>
      <button class="chip" data-min="10">10m</button>
      <button class="chip" data-min="15">15m</button>
      <button class="chip" id="customBtn">Custom…</button>
    </section>

    <section class="timer-card">
      <div class="ring" id="ring" aria-hidden="true"></div>
      <div class="time" id="time" aria-live="polite">05:00</div>

      <div class="controls">
        <button id="startBtn" class="primary">Start</button>
        <button id="pauseBtn" class="ghost" disabled>Pause</button>
        <button id="resetBtn" class="ghost" disabled>Reset</button>
      </div>

      <div class="status">
        <button id="testToneBtn" class="link" aria-label="Test end chime (unlocks audio)">test tone</button>
        <span id="soundHint" class="hint">• end tone enabled</span>
      </div>
    </section>
  </main>

  <div id="completeSheet" class="sheet" hidden>
    <div class="sheet-body">
      <h2>Session complete</h2>
      <div class="sheet-actions">
        <button id="replayBtn" class="primary">Replay</button>
        <button id="chooseBtn" class="ghost">Choose another</button>
      </div>
    </div>
  </div>

  <div id="iosA2H" class="a2h" hidden>
    <p>Add to Home for a clean, fullscreen experience.</p>
    <button id="dismissA2H" class="link">dismiss</button>
  </div>

  <dialog id="customDialog">
    <form method="dialog" id="customForm">
      <h3>Custom time</h3>
      <div class="grid">
        <label>Minutes
          <input id="minInput" type="number" inputmode="numeric" min="0" max="999" value="5" />
        </label>
        <label>Seconds
          <input id="secInput" type="number" inputmode="numeric" min="0" max="59" value="0" />
        </label>
      </div>
      <menu>
        <button value="cancel" class="ghost">Cancel</button>
        <button value="ok" class="primary">Set</button>
      </menu>
    </form>
  </dialog>

  <dialog id="helpDialog">
    <article>
      <h3>Meditate — minimal timer</h3>
      <p>Pick a time, press Start. The app plays a soft chime when done.</p>
      <ul>
        <li>Add to Home for fullscreen.</li>
        <li>Audio unlocks on your first tap.</li>
        <li>Timing stays accurate even if the screen sleeps.</li>
      </ul>
      <form method="dialog">
        <button class="primary">Close</button>
      </form>
    </article>
  </dialog>

  <!-- Visual overlays for flash + dim -->
  <div id="flashOverlay"></div>
  <div id="dimOverlay"></div>

  <script>
/* Meditate — MVP timer with WebAudio chime */

const el = (id) => document.getElementById(id);
const timeEl = el('time');
const ringEl = el('ring');
const startBtn = el('startBtn');
const pauseBtn = el('pauseBtn');
const resetBtn = el('resetBtn');
const testToneBtn = el('testToneBtn');
const soundHint = el('soundHint');

const customBtn = el('customBtn');
const infoBtn = el('infoBtn');
const helpDialog = el('helpDialog');

const customDialog = el('customDialog');
const customForm = el('customForm');
const minInput = el('minInput');
const secInput = el('secInput');

const completeSheet = el('completeSheet');
const replayBtn = el('replayBtn');
const chooseBtn = el('chooseBtn');

const iosA2H = el('iosA2H');
const dismissA2H = el('dismissA2H');

const flashOverlay = el('flashOverlay');
const dimOverlay = el('dimOverlay');

const chips = Array.from(document.querySelectorAll('.chip-row .chip'));

let audioUnlocked = false;
let ac = null;

let durationMs = 5 * 60000;
let remainingMs = durationMs;
let targetTs = null;
let isRunning = false;
let paused = false;
let lastSelectedMs = durationMs;
let rafId = null;
let wakeLock = null;

const dimTimeoutMs = 5000; // 5 seconds of no interaction
let dimTimerId = null;

/* Wake Lock: keep screen awake during meditation */
async function requestWakeLock() {
  if ('wakeLock' in navigator && isRunning && !paused) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
    } catch (err) {
      // Wake lock request failed - not critical, timer still works
    }
  }
}

async function releaseWakeLock() {
  if (wakeLock !== null) {
    try {
      await wakeLock.release();
      wakeLock = null;
    } catch (err) {
      // Wake lock release failed - not critical
    }
  }
}

/* Audio: create soft chime (WebAudio) */
function ensureAudio() {
  if (!ac) {
    try {
      ac = new (window.AudioContext || window.webkitAudioContext)();
      console.log('AudioContext created, state:', ac.state);
    } catch (err) {
      console.error('Failed to create AudioContext:', err);
      soundHint.textContent = '• audio not supported';
      return false;
    }
  }
  return true;
}

async function unlockAudio() {
  if (!ensureAudio()) return;

  console.log('Attempting to unlock audio, current state:', ac.state);

  if (ac.state === 'suspended') {
    try {
      await ac.resume();
      console.log('AudioContext resumed, new state:', ac.state);
    } catch (err) {
      console.error('Failed to resume AudioContext:', err);
      soundHint.textContent = '• audio unlock failed';
      return;
    }
  }

  audioUnlocked = ac.state === 'running';
  console.log('Audio unlocked:', audioUnlocked);
  soundHint.textContent = audioUnlocked ? '• end tone enabled' : '• tap "test tone" to enable sound';
}

function playChime() {
  console.log('playChime called, audioUnlocked:', audioUnlocked);

  if (!audioUnlocked) {
    console.log('Audio not unlocked, skipping chime');
    return;
  }

  if (!ensureAudio()) return;

  try {
    const now = ac.currentTime;
    const duration = 1.25;
    const osc = ac.createOscillator();
    const gain = ac.createGain();

    osc.type = 'sine';
    osc.frequency.setValueAtTime(520, now);
    osc.frequency.linearRampToValueAtTime(660, now + duration);

    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.08, now + 0.06);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    osc.connect(gain).connect(ac.destination);
    osc.start(now);
    osc.stop(now + duration);

    console.log('Chime played successfully');
  } catch (err) {
    console.error('Failed to play chime:', err);
  }
}

/* --- Flash overlay at session end --- */
function triggerFlash() {
  if (!flashOverlay) return;

  // Restart animation if already in progress
  flashOverlay.classList.remove('flash-on');
  // Force reflow so the animation can re-trigger
  void flashOverlay.offsetWidth;
  flashOverlay.classList.add('flash-on');
}

/* --- Dim behavior during running sessions --- */

function scheduleDim() {
  clearTimeout(dimTimerId);
  if (!isRunning || paused) {
    document.body.classList.remove('dimmed');
    return;
  }
  dimTimerId = setTimeout(() => {
    if (isRunning && !paused) {
      document.body.classList.add('dimmed');
    }
  }, dimTimeoutMs);
}

function clearDim() {
  clearTimeout(dimTimerId);
  document.body.classList.remove('dimmed');
}

/* Any interaction should clear dim + restart the dim timer if running */
['pointerdown', 'touchstart', 'keydown'].forEach(evt => {
  window.addEventListener(
    evt,
    () => {
      clearDim();
      if (isRunning && !paused) {
        scheduleDim();
      }
    },
    { passive: true }
  );
});

function fmt(ms) {
  const s = Math.max(0, Math.round(ms / 1000));
  const mm = String(Math.floor(s / 60)).padStart(2, '0');
  const ss = String(s % 60).padStart(2, '0');
  return mm + ':' + ss;
}

function setRingProgress(msLeft, total) {
  const frac = 1 - Math.min(1, Math.max(0, msLeft / total));
  const deg = Math.floor(frac * 360);
  document.documentElement.style.setProperty('--deg', deg + 'deg');
}

function render(ms) {
  timeEl.textContent = fmt(ms);
  setRingProgress(ms, durationMs);
}

function startTimer(ms) {
  lastSelectedMs = ms || lastSelectedMs;
  durationMs = lastSelectedMs;
  targetTs = Date.now() + durationMs;
  isRunning = true;
  paused = false;
  startBtn.disabled = true;
  pauseBtn.disabled = false;
  resetBtn.disabled = false;
  requestWakeLock();
  scheduleDim();
  loop();
}

function pauseTimer() {
  if (!isRunning || paused) return;
  paused = true;
  remainingMs = Math.max(0, targetTs - Date.now());
  cancelAnimationFrame(rafId);
  releaseWakeLock();
  clearDim();
  startBtn.textContent = 'Resume';
  startBtn.disabled = false;
  pauseBtn.disabled = true;
}

function resumeTimer() {
  if (!paused) return;
  paused = false;
  targetTs = Date.now() + remainingMs;
  startBtn.disabled = true;
  pauseBtn.disabled = false;
  requestWakeLock();
  scheduleDim();
  loop();
}

function resetTimer() {
  // HARD RESET of all timer state
  isRunning = false;
  paused = false;
  targetTs = null;
  remainingMs = lastSelectedMs;
  if (rafId) {
    cancelAnimationFrame(rafId);
    rafId = null;
  }

  // Release resources
  releaseWakeLock();
  clearDim();

  // UI reset
  render(lastSelectedMs);
  startBtn.textContent = 'Start';
  startBtn.disabled = false;
  pauseBtn.disabled = true;
  resetBtn.disabled = true;
  document.documentElement.style.setProperty('--deg', '0deg');
}

function loop() {
  if (!isRunning || paused) return;
  const now = Date.now();
  const left = Math.max(0, targetTs - now);
  render(left);

  if (left <= 0) {
    isRunning = false;
    cancelAnimationFrame(rafId);
    releaseWakeLock();
    clearDim();
    triggerFlash();
    startBtn.textContent = 'Start';
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    resetBtn.disabled = false;
    playChime();
    openCompleteSheet();
    return;
  }
  rafId = requestAnimationFrame(loop);
}

function openCompleteSheet() { completeSheet.hidden = false; }
function closeCompleteSheet() { completeSheet.hidden = true; }

chips.forEach(btn => {
  btn.addEventListener('click', () => {
    chips.forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    if (btn.id === 'customBtn') {
      customDialog.showModal();
      return;
    }
    const mins = Number(btn.dataset.min || 5);
    lastSelectedMs = mins * 60000;
    render(lastSelectedMs);
  });
});

document.querySelector('.chip[data-min="5"]').classList.add('active');

startBtn.addEventListener('click', async () => {
  await unlockAudio();
  if (paused) resumeTimer();
  else startTimer(lastSelectedMs);
});

pauseBtn.addEventListener('click', pauseTimer);
resetBtn.addEventListener('click', resetTimer);

testToneBtn.addEventListener('click', async () => {
  await unlockAudio();
  playChime();
});

replayBtn.addEventListener('click', () => {
  closeCompleteSheet();
  startTimer(lastSelectedMs);
});
chooseBtn.addEventListener('click', () => {
  closeCompleteSheet();
  resetTimer();
});

infoBtn.addEventListener('click', () => helpDialog.showModal());

customDialog.addEventListener('close', () => {
  if (customDialog.returnValue !== 'ok') return;
  const m = Math.max(0, Math.min(999, Number(minInput.value || 0)));
  const s = Math.max(0, Math.min(59, Number(secInput.value || 0)));
  lastSelectedMs = (m * 60 + s) * 1000;
  render(lastSelectedMs);
});

customForm.addEventListener('submit', (e) => {
  // allow dialog to close with value="ok"
});

document.addEventListener('visibilitychange', () => {
  if (!isRunning || paused) return;
  // Re-render based on absolute target
  const left = Math.max(0, targetTs - Date.now());
  render(left);
  // Re-acquire wake lock if page becomes visible during active session
  if (document.visibilityState === 'visible') {
    requestWakeLock();
  }
});

render(lastSelectedMs);

// Don't auto-show iOS Add to Home notification - let user dismiss if visible
dismissA2H.addEventListener('click', () => { iosA2H.hidden = true; });
  </script>
</body>
</html>
